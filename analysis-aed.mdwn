% Deanonymisation attacks on the Tor network 2013-2014
% Alan Dawson
% December 2014

# Tor

Tor is a low latency anonymisation  and privacy platform for network traffic.  

- Low latency, in that it's usable for everyday browsing. 
- Anonymisation in that it seeks to prevent network operators identifying the source of traffic.
- Privacy in that it seeks to prevent network operators identifying the content of traffic.

# How does it work

The Tor client, known as a an Onion Proxy (OP) bootstraps itself at startup. This involves the following stages:- 

- The OP contacts the Tor Directory Authorities (DA), and downloads a list of the currently available Tor relays (OR) together with their exit node policies, public keys and other information.  
- The OP selects an exit node, that is suitable for the traffic it wants to send.
- The OP then selects an number of OR ( {OR_1}...{OR_n} ) to create a circuit to the exit node.  In practice this is just 2 OR, an entrance, known as a Guard Node, and a relay node.
- The OP creates a circuit to the guard node.
- The OP extends the circuit to the relay, and from there extends it to the exit node.

In this way OP builds a circuit across 3 OR.  Each OR is only aware of the previous hop and destination hop.  

In practice a OP will buil several circuits, with various relay and exit nodes, but will keep the same guard node ( entrance ) for extended periods of time.

# Attacks on Tor Clients

## Evil exit node

Unless the traffic from the destination is authenticated then an evil exit node can insert or alter any responses from the destination to the client. Examples of authenticated traffic are: 

- https traffic with certificate verification. This will provide end to end authentication and encryption of destination to the client
- downloading of data that has a cryptographically verifiable signature, where the signature can be verified via a different channel.  This would allow the exit node to see the traffic still, but the client would be able to tell verify the content.  Examples of this would be the downloading of packages from Windows Update.  The exit node would be able see which updates were being downloaded, but an attempt to tamper with them would invalidate cryptographic signatures.

Examples of unauthenticated traffic would include browsing over http, the use of internet relay chat and  Window Live Messenger.

## Tor browser bundle exploit

A common error for users is to use the same browser on the Tor network as they do for everyday browsing. Websites will store small pieces of information to identify users called cookies to maintain state or to track for advertising purposes. When this browser is then used to visit websites across the Tor network, these same cookies will reveal the users identity.  To prevent this the Tor project produces a customised version of the Firefox browser which has scripting, plugins, and cookies disabled.  This is known as the Tor Browser Bundle.

This customised verion of Firefox is vulnerable though to any exploits that other versions of Firefox are, and it's important that Tor users keep their versions of the TBB up to date.


## Directory Authorities  compromise

The Tor network has 10 Directory Authorities. These contain a list of the currently active Tor routers, and other information that is required for a OP to bootstrap a circuit.  These Directory Authorities are hardcoded into the Tor client. They are updated hourly, and build a consensus over the state of the Tor network.  9 of these DA act for the general Tor client, and one acts for Tor bridges.

If 5 of the DA's were taken over, then an attacker could control the view of the Tor network that clients received.  For example clients could be directed to select circuits that are all controlled by the attacker.  This would deanonymise Tor users.

As the DA are geographically diversely located in different legal regimes it would be difficult for an attacker to do this.  However it was rumoured that this was about to take place in December 19th 2014 https://blog.torproject.org/blog/possible-upcoming-attempts-disable-tor-network.  It's been noted that collusion between the German and US states could remove 5 Directory Authorities.


# Tor hidden services

Tor hidden services allow a service operartor to anonymise the location of the service. In standard use of Tor where a destination is not able to discover the IP address of client. When a service is published as a hidden service, the IP address of the service provider is anonymous.

Hidden services are published as ".onion" addresses.  For example facebook allow it to be accessed as https://facebookcorewwwi.onion, http://tnysbtbxsf356hiy.onion

The onion address is 80bit hash of the public key associated with the Tor hidden service, encoded in a 16 characters of base 32 ( [a-z][2-7] )


## Tor hidden service protocol

The hidden service builds a Tor circuit to a number of "introduction points" (IP).  The IP publish information about the hidden service into a distribited hash table, shared amongs special Tor nodes known as HSDir ( Hidden Service Directories ).

When a client wishes to connect to a hidden service, it performs several tasks, all across Tor circuits.

1. looks up the IP and public key info for the hidden service from a HSDir server, and  chooses an OR to be a Rendezvous Point (RP)
1. Asks the IP to contact the hidden service and tell it the RP
1. The HS makes a Tor circuit to the RP
1. The client makes a circuit to the RP

## Attacks on Tor hidden services


# How these attacks are used against Tor users

## Freedom Hosting 

Freedom hosting was company that offered a turnkey tor hidden service hosting. In August 2013 a large number of Tor hidden services hosted by Freedom hosting stopped serving their usual content, and instead started providing a web page saying they were down for maintenance. However, the maintenance web page had an embedded piece of Javascript, that exploited a vulnerability in the particular version of Firefox that the Tor Browser Bundle used at that time.  

The vulnerability has been extensively analysed by Dr Gareth Owen of Portsmouth University, "https://ghowen.me/fbi-tor-malware-analysis/"   "The malware phones home with identifying information from the user's computer and then crashes the firefox browser. In terms of sophistication, it's nothing special with no obfuscation and no new tricks that arent widely known other than the exploit. "

The exploit though is interesting as it records only 

1. the computer windows hostname 
1. the local IP address of the  computer  
1. the computers ethernet MAC address
1. a unique identifier linking these data to the web site accessed.

These were encoded into an HTTP request to an IP address in Virginia USA.  

This data recorded is typical of a law enforcement CIPAV ( Computer Internet Protocol Address Verifier ), and  substantially different to a general malware attack.  Malware attacks are more generally interested in monetizing the victim. For example, copying banking details, sending spam email, downloading additional malware component to form bot nets etc.. 

## Silk Road

## Harvard Bomb Threat

A Harvard Student in December 2013 emailed a bomb threat to the university authorities. He used the university wireless network to connect to the Tor network, and an anonymous email service to send the email.  Whilst the full details of his deanonymisation are not available some features stand out.

1. The subject authenticated against the university wireless network
1. It's common on public and authenticated wireless networks to have a high level of logging of source  and destination IP addresses and ports
1. Email often contains information regarding sending IP addresses and times in header information

### Example email header from  https://www.guerrillamail.com

This is an example  of a guerillamail.org email header, with the destination email address and server obfuscated.

~~~~~~~~

Return-path: <djajppp+fku4n0@guerrillamail.com>
Envelope-to: xxxxxxx@example.org
Delivery-date: Sat, 27 Dec 2014 18:19:40 +0000
Received: from mail.guerrillamail.com ([198.143.169.10] helo=guerrillamail.com)
        by xxxxxx.example.org with esmtp (Exim 4.80)
        (envelope-from <djajppp+fku4n0@guerrillamail.com>)
        id 1Y4vxj-0002LQ-1U
        for xxxxxxx@example.org; Sat, 27 Dec 2014 18:19:40 +0000 
Received: by 198.143.169.10 with HTTP; Sat, 27 Dec 2014 18:18:59 +0000
MIME-Version: 1.0
Message-ID: <94ee9dcba5ba1570d400693e9e61b42a567@guerrillamail.com>
Date: Sat, 27 Dec 2014 18:18:59 +0000
To: "xxxxxx@example.org" <xxxxxx@example.org>
From: djajppp+fku4n0@guerrillamail.com
Subject: test
X-Originating-IP: [72.52.75.27]


~~~~~~~~

The **exonerator** service from the Tor project shows that a particular IP address was acting as an exit node with a policy that allowed access to the service described in the email headers.

<https://exonerator.torproject.org/?timestamp=2014-12-27&ip=72.52.75.27&targetaddr=198.143.169.10&targetport=80#exit>





## Relay Early 

## Operation Onymous / Silk Road 2
